---
import PocketBase from "../../utils/pb";
import { Collections } from "../../utils/pocketbase-types";
import Layout from "../../layouts/Layout.astro";
import { ui } from "../../i18n/ui.js";

export const prerender = false;

const locale = (Astro.locals.lang as "en" | "fr") ?? "en";

const pb = PocketBase;

let svgs = [];

try {
    svgs = await pb.collection(Collections.Svg).getFullList(200, {
        sort: "-created",
        filter: `user = "${Astro.locals.user.id}"`, // Filtre pour n'afficher que les SVGs de l'utilisateur
    });
} catch (error) {
    console.error("Erreur lors de la récupération des SVGs :", error);
}
---

<Layout title={ui[locale].gallery.title}>
    <a class="text-blue-800" href="/generator"
        >{ui[locale].gallery.backToGenerator}</a
    >
    <h1>{ui[locale].gallery.title}</h1>

    {
        svgs.length > 0 ? (
            <div
                class="gallery"
                style="display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:1.5rem;"
            >
                {svgs.map((svg) => (
                    <div
                        class="card"
                        style="padding:1rem; border:1px solid #ccc; border-radius:10px; text-align:center; cursor:pointer;"
                        data-svg-id={svg.id}
                    >
                        <h3>{svg?.title}</h3>
                        <div set:html={svg?.code_svg} />
                        <p class="text-sm text-gray-600 mt-2">
                            {ui[locale].gallery.clickHistory}
                        </p>
                    </div>
                ))}
            </div>
        ) : (
            <p>{ui[locale].gallery.noSvg}</p>
        )
    }
</Layout>

<script>
    // Ajouter des écouteurs d'événements pour les cartes SVG
    document.addEventListener("DOMContentLoaded", () => {
        const cards = document.querySelectorAll(".card[data-svg-id]");

        cards.forEach((card) => {
            card.addEventListener("click", () => {
                const svgId = card.getAttribute("data-svg-id");
                if (svgId) {
                    // Rediriger vers la page de détail avec l'ID du SVG
                    window.location.href = `/gallery/${svgId}`;
                }
            });
        });
    });
</script>
